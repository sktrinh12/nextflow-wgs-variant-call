// dag.enabled = true
params.outdir = 'results'

docker {
    enabled = true
}

params {
    base_path = '.'
}

process {
    container = 'sktrinh12/bionfox-tools:1.1'
    withName: SPLIT_FASTQ {
        cpus      = 2
        memory    = '3 GB'
        label     = 'spot'
    }

    withName: CREATE_INTERVALS {
        cpus      = 2
        memory    = '3 GB'
        label     = 'spot'
    }

    withName: BWA_MEM {
        cpus      = 4
        memory    = '3 GB'
        label     = 'spot'
    }

    withName: MARK_DUPLICATES {
        container = 'broadinstitute/gatk:latest'
        cpus      = 2
        memory    = '3 GB'
        label     = 'spot'
    }

    withName: BASE_RECALIBRATOR {
        cpus      = 2
        memory    = '3 GB'
        label     = 'spot'
    }

    withName: APPLY_BQSR {
        cpus      = 4
        memory    = '3 GB'
        label     = 'spot'
    }

    withName: COLLECT_METRICS {
        container = 'broadinstitute/gatk:latest'
        cpus      = 2
        memory    = '3.25 GB'
        label     = 'spot'
    }

    withName: HAPLOTYPE_CALLER {
        cpus      = 4
        memory    = '3.25 GB'
        label     = 'ondemand'
    }

    withName: SELECT_VARIANTS {
        cpus      = 4
        memory    = '4 GB'
        label     = 'ondemand'
    }
}

profiles {

    local {
        process.executor = 'local'
    }

    awsbatch {

        process {
            executor = 'awsbatch'
            time     = '6h'
            queue = 'nf-spot-queue'

            withLabel: 'spot' {
                queue = 'nf-spot-queue'
                errorStrategy = 'retry'
                maxRetries = 2
            }

            withLabel: 'ondemand' {
                queue = 'nf-ondemand-queue'
                errorStrategy = 'terminate'
            }
        }

        aws {
            region = 'us-east-1'
            profile = 'rchsandbox'
        }

        params.base_path = '/workspace'
        params.outdir = 's3://preludetx-strinh/nextflow/wgs-variant-calling-bioinformagician/results'
        workDir = 's3://preludetx-strinh/nextflow/work'
    }

    k8s {
        process {
            executor = 'k8s'
            time     = '6h'

            withName: HAPLOTYPE_CALLER {
                cpus      = 2
                memory    = '3 GB'
            }

            withName: SELECT_VARIANTS {
                cpus      = 2
                memory    = '3 GB'
            }
        }

        k8s {
            namespace = 'default'

            storageClaimName = 'nextflow-pvc'
            storageMountPath = '/workspace'

            debug {
                yaml = true
            }
    }

        workDir = "/workspace/work"
        params.base_path = "/workspace"
        params.outdir    = '/workspace/results'
        executor {
            // The number of tasks the executor will handle in a parallel manner. A queue size of zero corresponds to no limit. Default varies for each executor.
            queueSize = 2
        }
    }
}
